# TeX Layer: Minimal TeX Live with LuaTeX for full Unicode support
# This layer is parallel to the Haskell layer, both built on Ubuntu base
FROM ghcr.io/git-steb/haskell-tex-dev:base-latest

# Switch to dev user for all operations
USER dev
WORKDIR /home/dev

# Install minimal TeX Live base with LuaTeX for full Unicode support
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    texlive-latex-base \
    texlive-binaries \
    texlive-luatex \
    latexmk \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install only the packages actually used in the project
RUN tlmgr update --self && \
    tlmgr install \
    amsmath \
    amssymb \
    amsthm \
    geometry \
    graphicx \
    tikz \
    xcolor \
    tcolorbox \
    booktabs \
    longtable \
    array \
    multirow \
    wrapfig \
    float \
    colortbl \
    pdflscape \
    tabu \
    threeparttable \
    threeparttablex \
    makecell \
    listings \
    fancyvrb \
    enumitem \
    setspace \
    parskip \
    etoolbox \
    datetime2 \
    fontawesome \
    physics \
    braket \
    siunitx \
    mathtools \
    textcomp \
    gensymb \
    esint \
    lineno \
    makeidx \
    animate \
    fancyhdr \
    forloop \
    dcolumn \
    bm \
    changepage \
    newunicodechar \
    marginnote \
    luaotfload \
    fontspec \
    unicode-math \
    && tlmgr path add

# Install only essential modern fonts
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    fonts-liberation \
    fonts-dejavu-core \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Set up user-mode TeX Live with tlmgr
RUN mkdir -p ~/.texmf && \
    echo "TEXMFHOME = ~/.texmf" >> ~/.texmf.cnf && \
    echo "TEXMFVAR = ~/.texmf/texmf-var" >> ~/.texmf.cnf && \
    echo "TEXMFCONFIG = ~/.texmf/texmf-config" >> ~/.texmf.cnf && \
    mkdir -p ~/.texmf/texmf-var ~/.texmf/texmf-config

# Create helpful documentation and scripts
RUN mkdir -p ~/.local/bin && \
    echo '#!/bin/bash' > ~/.local/bin/show-tex-versions && \
    echo 'echo "=== TeX Live ==="' >> ~/.local/bin/show-tex-versions && \
    echo 'pdflatex --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'lualatex --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'tlmgr --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'echo ""' >> ~/.local/bin/show-tex-versions && \
    echo 'echo "=== Installed Packages ==="' >> ~/.local/bin/show-tex-versions && \
    echo 'tlmgr list --only-installed | wc -l' >> ~/.local/bin/show-tex-versions && \
    chmod +x ~/.local/bin/show-tex-versions

# Add local bin to PATH
ENV PATH="/home/dev/.local/bin:$PATH"

# Create usage documentation
RUN echo "# TeX Layer: Minimal TeX Live with LuaTeX" > ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Features" >> ~/README-tex.md && \
    echo "- LuaTeX for full Unicode support" >> ~/README-tex.md && \
    echo "- Minimal package set (50+ vs 1500+ full collection)" >> ~/README-tex.md && \
    echo "- User-mode TeX Live with tlmgr" >> ~/README-tex.md && \
    echo "- Optimized for project needs" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Quick Start" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Check TeX versions:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "show-tex-versions" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Compile documents:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "# PDFLaTeX (traditional)" >> ~/README-tex.md && \
    echo "pdflatex document.tex" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "# LuaLaTeX (Unicode support)" >> ~/README-tex.md && \
    echo "lualatex document.tex" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "# Auto-compilation" >> ~/README-tex.md && \
    echo "latexmk -pdf document.tex" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Install additional packages:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "tlmgr install package-name" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Pre-installed Packages" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "Core: amsmath, amssymb, geometry, graphicx, tikz, xcolor" >> ~/README-tex.md && \
    echo "Tables: booktabs, longtable, array, multirow, tabu" >> ~/README-tex.md && \
    echo "Unicode: luaotfload, fontspec, unicode-math" >> ~/README-tex.md && \
    echo "Science: physics, siunitx, braket, esint" >> ~/README-tex.md && \
    echo "And 40+ more optimized for project needs..." >> ~/README-tex.md

# Set default command
CMD ["/bin/bash"]

# Labels for better image management
LABEL maintainer="git-steb"
LABEL org.opencontainers.image.source="https://github.com/git-steb/haskell-tex-dev"
LABEL org.opencontainers.image.description="TeX Live layer with LuaTeX for Unicode support"
LABEL org.opencontainers.image.title="Haskell TeX Dev - TeX Layer"
LABEL layer="tex"
LABEL features="tex,luatex,unicode,minimal-packages"
LABEL usage="docker run -it --rm -v \$(pwd):/workspace ghcr.io/git-steb/haskell-tex-dev:tex"
