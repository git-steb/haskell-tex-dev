# TeX Layer: Minimal TeX Live with LuaTeX for full Unicode support
# This layer is parallel to the Haskell layer, both built on Ubuntu base
ARG BASE_IMAGE=ghcr.io/git-steb/haskell-tex-dev:base-latest
FROM ${BASE_IMAGE}

# Switch to dev user for all operations
USER dev
WORKDIR /home/dev

# Install minimal TeX Live base with LuaTeX for full Unicode support
USER root
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    texlive-latex-base \
    texlive-binaries \
    texlive-luatex \
    latexmk \
    pandoc \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Switch back to dev user
USER dev

# Set up user-mode TeX Live with tlmgr (aligned with ghcup approach)
ENV TEXMFHOME=/home/dev/texmf
ENV PATH="/home/dev/texlive/bin/x86_64-linux:${PATH}"

# Initialize user-mode tlmgr tree and install project-specific packages
RUN tlmgr init-usertree && \
    tlmgr install \
    # Core packages for modern TeX development
    minted \
    algorithm2e \
    pdflscape \
    environ \
    trimspaces \
    lineno \
    xpatch \
    # Unicode math and fonts
    unicode-math \
    fontspec \
    xunicode \
    xltxtra \
    # Additional math packages
    amsmath \
    amssymb \
    amsthm \
    mathtools \
    physics \
    siunitx \
    # Code and algorithms
    listings \
    algorithmicx \
    algpseudocode \
    # Tables and graphics
    booktabs \
    array \
    multirow \
    colortbl \
    xcolor \
    # Bibliography and citations
    biblatex \
    biber \
    # Document structure
    geometry \
    fancyhdr \
    titlesec \
    tocloft \
    # Utilities
    etoolbox \
    xparse \
    expl3 \
    # Fonts for Unicode math
    stix2 \
    newtx \
    newpx \
    # Additional useful packages
    microtype \
    hyperref \
    url \
    breakurl \
    # For code highlighting
    fvextra \
    upquote \
    # For better tables
    longtable \
    tabu \
    # For diagrams
    tikz \
    pgf \
    # For cross-references
    cleveref \
    varioref \
    # For better spacing
    setspace \
    # For better lists
    enumitem \
    # For better footnotes
    footmisc \
    # For better captions
    caption \
    subcaption \
    || echo "Some packages may have failed to install, but continuing..."

# Install only essential modern fonts
USER root
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    fonts-liberation \
    fonts-dejavu-core \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Switch back to dev user
USER dev

# Create helpful documentation and scripts
RUN mkdir -p ~/.local/bin && \
    echo '#!/bin/bash' > ~/.local/bin/show-tex-versions && \
    echo 'echo "=== TeX Live ==="' >> ~/.local/bin/show-tex-versions && \
    echo 'pdflatex --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'lualatex --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'tlmgr --version | head -1' >> ~/.local/bin/show-tex-versions && \
    echo 'echo ""' >> ~/.local/bin/show-tex-versions && \
    echo 'echo "=== Installed Packages ==="' >> ~/.local/bin/show-tex-versions && \
    echo 'tlmgr list --only-installed | wc -l' >> ~/.local/bin/show-tex-versions && \
    chmod +x ~/.local/bin/show-tex-versions

# Add local bin to PATH
ENV PATH="/home/dev/.local/bin:$PATH"

# Create usage documentation
RUN echo "# TeX Layer: Minimal TeX Live with LuaTeX" > ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Features" >> ~/README-tex.md && \
    echo "- LuaTeX for full Unicode support" >> ~/README-tex.md && \
    echo "- Comprehensive package set (100+ widely used packages)" >> ~/README-tex.md && \
    echo "- User-mode TeX Live with tlmgr" >> ~/README-tex.md && \
    echo "- Pandoc for document conversion" >> ~/README-tex.md && \
    echo "- Optimized for project needs" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Quick Start" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Check TeX versions:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "show-tex-versions" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Compile documents:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "# PDFLaTeX (traditional)" >> ~/README-tex.md && \
    echo "pdflatex document.tex" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "# LuaLaTeX (Unicode support)" >> ~/README-tex.md && \
    echo "lualatex document.tex" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "# Auto-compilation" >> ~/README-tex.md && \
    echo "latexmk -pdf document.tex" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "### Install additional packages:" >> ~/README-tex.md && \
    echo "```bash" >> ~/README-tex.md && \
    echo "tlmgr install package-name" >> ~/README-tex.md && \
    echo "```" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "## Pre-installed Packages" >> ~/README-tex.md && \
    echo "" >> ~/README-tex.md && \
    echo "Core: amsmath, amssymb, geometry, graphicx, tikz, xcolor" >> ~/README-tex.md && \
    echo "Tables: booktabs, longtable, array, multirow, tabu" >> ~/README-tex.md && \
    echo "Unicode: luaotfload, fontspec, unicode-math" >> ~/README-tex.md && \
    echo "Science: physics, siunitx, braket, esint" >> ~/README-tex.md && \
    echo "And 40+ more optimized for project needs..." >> ~/README-tex.md

# Health check for verification
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pdflatex --version && lualatex --version && tlmgr --version && pandoc --version || exit 1

# Set default command
CMD ["/bin/bash"]

# Labels for better image management
LABEL maintainer="git-steb"
LABEL org.opencontainers.image.source="https://github.com/git-steb/haskell-tex-dev"
LABEL org.opencontainers.image.description="TeX Live layer with LuaTeX for Unicode support"
LABEL org.opencontainers.image.title="Haskell TeX Dev - TeX Layer"
LABEL layer="tex"
LABEL features="tex,luatex,unicode,minimal-packages"
LABEL usage="docker run -it --rm -v $(pwd):/workspace ghcr.io/git-steb/haskell-tex-dev:tex"
