# Base layer: Ubuntu foundation for parallel TeX and Haskell layers
# This creates the foundation for independent toolchain layers
FROM ubuntu:24.04

# Build arguments for flexible toolchain versions
ARG GHC_VERSION=9.12.2
ARG CABAL_VERSION=3.16.0.0
ARG HLS_VERSION=2.10.0.0
ARG STACK_VERSION=3.7.1

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV CABAL_DIR=/home/dev/.cabal
ENV PATH=/home/dev/.cabal/bin:$PATH

# Install system dependencies (shared between TeX and Haskell)
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    curl \
    wget \
    git \
    build-essential \
    libgmp-dev \
    libffi-dev \
    libncurses5-dev \
    libtinfo5 \
    libgmp10 \
    libffi8 \
    libncurses6 \
    ca-certificates \
    python3 \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create dev user with sudo access
RUN useradd -m -s /bin/bash -u 1001 dev && \
    echo "dev:dev" | chpasswd && \
    usermod -aG sudo dev && \
    echo "dev ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Switch to dev user for all operations
USER dev
WORKDIR /home/dev

# Set up Python virtual environment for CI tools
RUN python3 -m venv ~/.ci-venv && \
    echo 'source ~/.ci-venv/bin/activate' >> ~/.bashrc && \
    echo 'export PATH="$HOME/.ci-venv/bin:$PATH"' >> ~/.bashrc

# Create workspace directory
RUN mkdir -p /workspace

# Create helpful documentation
RUN echo "# Ubuntu Base for Parallel TeX and Haskell Layers" > ~/README.md && \
    echo "" >> ~/README.md && \
    echo "## Architecture" >> ~/README.md && \
    echo "" >> ~/README.md && \
    echo "This base image provides the foundation for parallel layers:" >> ~/README.md && \
    echo "- **TeX Layer**: Minimal TeX Live with LuaTeX for Unicode support" >> ~/README.md && \
    echo "- **Haskell Layer**: GHC 9.12.2 with native WASM support" >> ~/README.md && \
    echo "" >> ~/README.md && \
    echo "## Environment Details" >> ~/README.md && \
    echo "" >> ~/README.md && \
    echo "- **User**: dev (UID 1001)" >> ~/README.md && \
    echo "- **Home**: /home/dev" >> ~/README.md && \
    echo "- **Workspace**: /workspace" >> ~/README.md && \
    echo "- **Python Venv**: ~/.ci-venv" >> ~/README.md && \
    echo "" >> ~/README.md && \
    echo "## Next Steps" >> ~/README.md && \
    echo "" >> ~/README.md && \
    echo "Build parallel layers:" >> ~/README.md && \
    echo "- docker build -f Dockerfile.tex -t haskell-tex-dev:tex ." >> ~/README.md && \
    echo "- docker build -f Dockerfile.haskell -t haskell-tex-dev:haskell ." >> ~/README.md

# Set default command
CMD ["/bin/bash"]

# Labels for better image management
LABEL maintainer="git-steb"
LABEL org.opencontainers.image.source="https://github.com/git-steb/haskell-tex-dev"
LABEL org.opencontainers.image.description="Ubuntu base for parallel TeX and Haskell layers"
LABEL org.opencontainers.image.title="Haskell TeX Dev Base"
LABEL architecture="parallel-layers"
LABEL usage="Base for parallel TeX and Haskell toolchain layers"
