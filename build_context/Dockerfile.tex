# TeX Layer: Complete TeX Live environment with LuaTeX for Unicode support
# This provides a comprehensive TeX environment for document generation
# Built on top of Haskell layer to create the full Haskell + TeX environment
ARG BASE_IMAGE=ghcr.io/git-steb/haskell-tex-dev:haskell-latest
# VERSION is read from the VERSION file in the repository root
ARG VERSION
FROM ${BASE_IMAGE}

# Declare build args in this stage before using them
ARG VERSION
ENV VERSION=${VERSION}

# Load version definitions from versions.env
COPY build_context/versions.env /tmp/versions.env
RUN set -a && . /tmp/versions.env && set +a

# Switch to root to install TeX Live
USER root

# Install Java dependencies first with proper error handling
RUN apt-get update && \
    mkdir -p /usr/share/man/man1 && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    openjdk-21-jre-headless \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install TeX Live base with LuaTeX for full Unicode support
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    texlive-latex-base \
    texlive-binaries \
    texlive-luatex \
    texlive-latex-extra \
    latexmk \
    pandoc \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Switch to dev user for TeX setup
USER dev
WORKDIR /home/dev

# Verify Haskell tools are available from base image
RUN ghc --version && cabal --version && echo "✅ Haskell tools verified"

# Set up user-mode TeX Live with tlmgr (aligned with ghcup approach)
ENV TEXMFHOME=/home/dev/texmf
ENV PATH="/home/dev/.local/bin:/opt/texlive/texdir/bin/x86_64-linux:$PATH"
ENV TEXINPUTS="$TEXMFHOME/tex/latex//:"

# Initialize user-mode tlmgr tree and update to latest version
RUN tlmgr init-usertree && \
    tlmgr option repository https://mirror.ctan.org/systems/texlive/tlnet && \
    tlmgr option autoinstall 1 && \
    tlmgr update --self --all || echo "tlmgr update completed" && \
    tlmgr install \
    # Core packages for modern TeX development
    minted \
    algorithm2e \
    pdflscape \
    environ \
    trimspaces \
    lineno \
    xpatch \
    # Unicode math and fonts
    unicode-math \
    fontspec \
    xunicode \
    xltxtra \
    # Additional math packages
    amsmath \
    amssymb \
    amsthm \
    mathtools \
    physics \
    siunitx \
    # Code and algorithms
    listings \
    algorithmicx \
    algpseudocode \
    # Tables and graphics
    booktabs \
    array \
    multirow \
    colortbl \
    xcolor \
    # Bibliography and citations
    biblatex \
    biber \
    # Document structure
    geometry \
    fancyhdr \
    titlesec \
    tocloft \
    # Utilities
    etoolbox \
    xparse \
    expl3 \
    # Fonts for Unicode math
    stix2 \
    newtx \
    newpx \
    # Additional useful packages
    microtype \
    hyperref \
    url \
    breakurl \
    # For code highlighting
    fvextra \
    upquote \
    # For better tables
    longtable \
    tabu \
    # For diagrams
    tikz \
    pgf \
    # For cross-references
    cleveref \
    varioref \
    # For better spacing
    setspace \
    # For better lists
    enumitem \
    # For better footnotes
    footmisc \
    # For better captions
    caption \
    subcaption \
    || echo "Some packages may have failed to install, but continuing..."

# Install only essential modern fonts
USER root
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    fonts-liberation \
    fonts-dejavu-core \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Switch back to dev user
USER dev

# Create helpful documentation and scripts
RUN mkdir -p ~/.local/bin && \
    echo '#!/bin/bash' > ~/.local/bin/show-all-versions && \
    echo 'echo "=== Haskell Toolchain ==="' >> ~/.local/bin/show-all-versions && \
    echo 'ghc --version' >> ~/.local/bin/show-all-versions && \
    echo 'cabal --version' >> ~/.local/bin/show-all-versions && \
    echo 'stack --version' >> ~/.local/bin/show-all-versions && \
    echo 'echo ""' >> ~/.local/bin/show-all-versions && \
    echo 'echo "=== WASM Support ==="' >> ~/.local/bin/show-all-versions && \
    echo 'ghc --supported-targets | grep wasm || echo "WASM target not available"' >> ~/.local/bin/show-all-versions && \
    echo 'echo ""' >> ~/.local/bin/show-all-versions && \
    echo 'echo "=== TeX Toolchain ==="' >> ~/.local/bin/show-all-versions && \
    echo 'pdflatex --version | head -1' >> ~/.local/bin/show-all-versions && \
    echo 'lualatex --version | head -1' >> ~/.local/bin/show-all-versions && \
    echo 'latexmk --version | head -1' >> ~/.local/bin/show-all-versions && \
    echo 'tlmgr --version | head -1' >> ~/.local/bin/show-all-versions && \
    echo 'echo ""' >> ~/.local/bin/show-all-versions && \
    echo 'echo "=== Installed Packages ==="' >> ~/.local/bin/show-all-versions && \
    echo 'tlmgr list --only-installed | wc -l' >> ~/.local/bin/show-all-versions && \
    chmod +x ~/.local/bin/show-all-versions && \
    echo '#!/bin/bash' > ~/.local/bin/test-tex-tools && \
    echo 'echo "Testing TeX tools availability..."' >> ~/.local/bin/test-tex-tools && \
    echo 'which pdflatex && echo "✅ pdflatex found"' >> ~/.local/bin/test-tex-tools && \
    echo 'which lualatex && echo "✅ lualatex found"' >> ~/.local/bin/test-tex-tools && \
    echo 'which latexmk && echo "✅ latexmk found"' >> ~/.local/bin/test-tex-tools && \
    echo 'which tlmgr && echo "✅ tlmgr found"' >> ~/.local/bin/test-tex-tools && \
    echo 'which pandoc && echo "✅ pandoc found"' >> ~/.local/bin/test-tex-tools && \
    echo "All TeX tools are available!" >> ~/.local/bin/test-tex-tools && \
    chmod +x ~/.local/bin/test-tex-tools && \
    echo '#!/bin/bash' > ~/.local/bin/install-tex-package && \
    echo 'echo "Installing TeX package: $1"' >> ~/.local/bin/install-tex-package && \
    echo 'tlmgr --force install "$1"' >> ~/.local/bin/install-tex-package && \
    echo 'echo "Package $1 installed successfully!"' >> ~/.local/bin/install-tex-package && \
    chmod +x ~/.local/bin/install-tex-package

# Create usage documentation
RUN echo "# Full Layer: Haskell + TeX Combined" > ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "## Features" >> ~/README-full.md && \
    echo "- GHC 9.12.2 with native WebAssembly support" >> ~/README-full.md && \
    echo "- Complete TeX Live with LuaTeX for Unicode support" >> ~/README-full.md && \
    echo "- Cabal, Stack, HLS, and Ormolu for Haskell development" >> ~/README-full.md && \
    echo "- User-mode TeX Live with tlmgr for package management" >> ~/README-full.md && \
    echo "- Comprehensive TeX package set pre-installed (minted, amsmath, tikz, etc.)" >> ~/README-full.md && \
    echo "- Python 3 and Node.js for CI and web development" >> ~/README-full.md && \
    echo "- Optimized for HASM (Haskell + TeX) applications" >> ~/README-full.md && \
    echo "- Supports lemma validation and book building workflows" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "## Quick Start" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Check all versions:" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "show-all-versions" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Haskell development:" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "cabal init my-project" >> ~/README-full.md && \
    echo "cd my-project" >> ~/README-full.md && \
    echo "cabal build" >> ~/README-full.md && \
    echo "cabal run" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### WebAssembly compilation:" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "ghc -target wasm32-wasi -o app.wasm Main.hs" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### TeX document compilation:" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "# PDFLaTeX (traditional)" >> ~/README-full.md && \
    echo "pdflatex document.tex" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "# LuaLaTeX (Unicode support)" >> ~/README-full.md && \
    echo "lualatex document.tex" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Install additional TeX packages:" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "# Note: Version mismatch between local (2023) and remote (2025) repositories" >> ~/README-full.md && \
    echo "# Most packages are already installed system-wide" >> ~/README-full.md && \
    echo "# To check if a package is available:" >> ~/README-full.md && \
    echo "find /usr/share/texlive -name 'package-name.sty' 2>/dev/null" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "# To install new packages (if needed):" >> ~/README-full.md && \
    echo "# Option 1: Use system package manager" >> ~/README-full.md && \
    echo "sudo apt-get install texlive-package-name" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "# Option 2: Force install with tlmgr (may not work due to version mismatch)" >> ~/README-full.md && \
    echo "tlmgr --force install package-name" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "## Homeomorphosis CI Support" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "This image is specifically designed to support:" >> ~/README-full.md && \
    echo "- **Lemma Validation**: Python scripts with numpy, pandas, matplotlib" >> ~/README-full.md && \
    echo "- **Book Building**: Complete TeX Live with all required packages" >> ~/README-full.md && \
    echo "- **HASM Shell**: Haskell toolchain for hasm-shell execution" >> ~/README-full.md && \
    echo "- **CI/CD**: Unified workflow support with proper user permissions" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "## Use Cases" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "- **HASM Applications**: Haskell + TeX for document generation" >> ~/README-full.md && \
    echo "- **Web Development**: Haskell backend with WASM frontend" >> ~/README-full.md && \
    echo "- **Academic Writing**: TeX documents with Haskell data processing" >> ~/README-full.md && \
    echo "- **CI/CD**: Complete toolchain for automated builds" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "## TeX Package Management" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Pre-installed Packages" >> ~/README-full.md && \
    echo "The image includes a comprehensive set of TeX packages:" >> ~/README-full.md && \
    echo "- **Core**: minted, algorithm2e, pdflscape, environ, trimspaces" >> ~/README-full.md && \
    echo "- **Math**: amsmath, amssymb, amsthm, mathtools, physics, siunitx" >> ~/README-full.md && \
    echo "- **Code**: listings, algorithmicx, algpseudocode, fancyvrb" >> ~/README-full.md && \
    echo "- **Graphics**: tikz, pgf, xcolor, booktabs, array, multirow" >> ~/README-full.md && \
    echo "- **Bibliography**: biblatex, biber" >> ~/README-full.md && \
    echo "- **Document**: geometry, fancyhdr, titlesec, tocloft" >> ~/README-full.md && \
    echo "- **Fonts**: unicode-math, fontspec, stix2, newtx, newpx" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Adding New Packages" >> ~/README-full.md && \
    echo "User-level package installation is supported using the helper script:" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "1. **Easy installation**: `install-tex-package package-name`" >> ~/README-full.md && \
    echo "2. **Check if already installed**: `find /usr/share/texlive -name 'package.sty'`" >> ~/README-full.md && \
    echo "3. **Manual installation**: `cd /home/dev && tlmgr --force install package-name`" >> ~/README-full.md && \
    echo "4. **System packages**: `sudo apt-get install texlive-package-name`" >> ~/README-full.md && \
    echo "" >> ~/README-full.md && \
    echo "### Testing Package Availability" >> ~/README-full.md && \
    echo "```bash" >> ~/README-full.md && \
    echo "# Test if a package works" >> ~/README-full.md && \
    echo "echo '\\documentclass{article}\\usepackage{package-name}\\begin{document}Test\\end{document}' > test.tex" >> ~/README-full.md && \
    echo "pdflatex test.tex" >> ~/README-full.md && \
    echo "```" >> ~/README-full.md

# Health check for verification
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ghc --version && cabal --version && pdflatex --version && lualatex --version && tlmgr --version || exit 1

# Set default command
CMD ["/bin/bash"]

# Labels for better image management
LABEL maintainer="git-steb"
LABEL org.opencontainers.image.source="https://github.com/git-steb/haskell-tex-dev"
LABEL org.opencontainers.image.description="Complete Haskell + TeX development environment"
LABEL org.opencontainers.image.title="Haskell TeX Dev - Full Layer"
LABEL layer="full"
LABEL features="haskell,tex,ghc,wasm,cabal,stack,hls,luatex,unicode,homeomorphosis"
LABEL usage="docker run -it --rm -v $(pwd):/workspace ghcr.io/git-steb/haskell-tex-dev:latest"
LABEL version="v${VERSION}"
